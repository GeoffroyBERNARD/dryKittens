// data declaration
// can be optimized...

let Baron = {
    "index" : "0",
	"name" : "BaronGOF",
    "battletags" : ["BaronGOF-2402", "TheDebaser-21783"],
    "loaded" : null,
	"rank": [],
    "level" : null,
    "playerIcon" : null,
	"rankIcon" : null,
	"averageRankIcon" : null,
	"maxRank" : null,
	"averageRank" : null,
	"wins" : [],
	"winrate" : null,
	"loss" : [],
	"draws" : [],
    "games" : [],
    "winsTotal" : null,
    "lossTotal" : null,
    "drawsTotal" : null,
    "gamesTotal" : null,
	"winrateColor" : null,
	"endorsement" : null,
	"display" : false,
	"mostPlayedKey" : null,
	"mostPlayedTime" : null,
	"mostPlayed" : null,
	"lastUpdated" : null,
	"lastUpdatedTimer" : null,
	"fetching" : false
}

let Metodios = {
    "index" : "1",
	"name" : "Metodios",
	"battletags" : ["Metodios-2865", "Motodies-2516"],
	"rank": [],
    "level" : 0,
    "loaded" : null,
	"rankIcon" : null,
	"averageRankIcon" : null,
	"maxRank" : null,
	"averageRank" : null,
	"playerIcon" : null,
	"wins" : [],
	"winrate" : null,
	"loss" : [],
    "games" : [],
	"draws" : [],
    "winsTotal" : null,
    "lossTotal" : null,
    "drawsTotal" : null,
    "gamesTotal" : null,
	"winrateColor" : null,
	"endorsement" : null,
	"display" : false,
	"mostPlayedKey" : null,
	"mostPlayedTime" : null,
	"mostPlayed" : null,
	"lastUpdated" : null,
	"lastUpdatedTimer" : null,
	"fetching" : false
}

let Alykas = {
    "index" : "2",
	"name" : "Alykas",
	"battletags" : ["Alykas-2309", "Sacha-21922", "Sacha-21159"],
	"rank": [],
	"level" : 0,
    "rankIcon" : null,
    "loaded" : null,
	"averageRankIcon" : null,
	"maxRank" : null,
	"averageRank" : null,
	"playerIcon" : null,
	"wins" : [],
	"winrate" : null,
	"loss" : [],
    "games" : [],
	"draws" : [],
    "winsTotal" : null,
    "lossTotal" : null,
    "drawsTotal" : null,
    "gamesTotal" : null,
	"winrateColor" : null,
	"endorsement" : null,
	"display" : false,
	"mostPlayedKey" : null,
	"mostPlayedTime" : null,
	"mostPlayed" : null,
	"lastUpdated" : null,
	"lastUpdatedTimer" : null,
	"fetching" : false
}

let Veybex = {
    "index" : "3",
	"name" : "Veybex",
	"battletags" : ["Veybex-2428", "Sparks-21157"],
	"rank": [],
	"level" : 0,
    "rankIcon" : null,
    "loaded" : null,
	"averageRankIcon" : null,
	"maxRank" : null,
	"averageRank" : null,
	"playerIcon" : null,
	"wins" : [],
	"winrate" : null,
	"loss" : [],
    "games" : [],
	"draws" : [],
    "winsTotal" : null,
    "lossTotal" : null,
    "drawsTotal" : null,
    "gamesTotal" : null,
	"winrateColor" : null,
	"endorsement" : null,
	"display" : false,
	"mostPlayedKey" : null,
	"mostPlayedTime" : null,
	"mostPlayed" : null,
	"lastUpdated" : null,
	"lastUpdatedTimer" : null,
	"fetching" : false
}

let Aku = {
    "index" : "4",
	"name" : "Aku",
	"battletags" : ["Aku-22455"],
	"rank": [],
	"level" : 0,
	"rankIcon" : null,
    "averageRankIcon" : null,
    "loaded" : null,
	"maxRank" : null,
	"averageRank" : null,
	"playerIcon" : null,
	"wins" : [],
	"winrate" : null,
	"loss" : [],
    "games" : [],
    "draws" : [],
    "winsTotal" : null,
    "lossTotal" : null,
    "drawsTotal" : null,
    "gamesTotal" : null,
	"winrateColor" : null,
	"endorsement" : null,
	"display" : false,
	"mostPlayedKey" : null,
	"mostPlayedTime" : null,
	"mostPlayed" : null,
	"lastUpdated" : null,
	"lastUpdatedTimer" : null,
	"fetching" : false
}

let Greenfinite = {
    "index" : "5",
	"name" : "Greenfinite",
	"battletags" : ["Greenfinite-2408"],
	"level" : 0,
    "rankIcon" : null,
    "loaded" : null,
	"averageRankIcon" : null,
	"maxRank" : null,
	"averageRank" : null,
	"playerIcon" : null,
	"rank": [],
	"wins" : [],
	"winrate" : null,
	"loss" : [],
    "games" : [],
	"draws" : [],
    "winsTotal" : null,
    "lossTotal" : null,
    "drawsTotal" : null,
    "gamesTotal" : null,
	"winrateColor" : null,
	"endorsement" : null,
	"display" : false,
	"mostPlayedKey" : null,
	"mostPlayedTime" : null,
	"mostPlayed" : null,
	"lastUpdated" : null,
	"lastUpdatedTimer" : null,
	"fetching" : false
}

let Jadixa = {
    "index" : "6",
	"name" : "Jadixa",
	"battletags" : ["Jadixa-2738"],
	"level" : 0,
    "rank": [],
    "loaded" : null,
	"rankIcon" : null,
	"averageRankIcon" : null,
	"maxRank" : null,
	"averageRank" : null,
	"playerIcon" : null,
	"wins" : [],
	"winrate" : null,
	"loss" : [],
    "draws" : [],
    "games" : [],
    "winsTotal" : null,
    "lossTotal" : null,
    "drawsTotal" : null,
    "gamesTotal" : null,
	"winrateColor" : null,
	"endorsement" : null,
	"display" : false,
	"mostPlayedKey" : null,
	"mostPlayedTime" : null,
	"mostPlayed" : null,
	"lastUpdated" : null,
	"lastUpdatedTimer" : null,
	"fetching" : false
}



let team = {
	"maxRank" : null,
	"maxRankPlayer" : null,
	"minRank" : null,
	"minRankPlayer" : null,
	"averageMaxRank" : null,
	"minRankIcon" : null,
	"maxRankIcon" : null,
	"averageMaxRankIcon": null
}

let tableId = {
    "BaronGOF" : 0,
    "Metodios" : 1,
    "Alykas" : 2,
    "Veybex" : 3,
    "Aku" : 4,
    "Greenfinite" : 5,
    "Jadixa" : 6
}

let heroes = ["ana", "ashe", "bastion", "brigitte", "dva", "doomfist", "genji", "hanzo", "junkrat", "lucio", "mccree", "mei", "mercy", "moira", "orisa", "pharah", "reaper", "reinhardt", "roadhog", "soldier76", "sombra", "symmetra", "torbjorn", "tracer", "widowmaker", "winston", "wrecking_ball", "zarya", "zenyatta" ]

//setting the vue

var app = new Vue({
    el: '#app',
    data: {
        players: [Baron, Metodios, Alykas, Veybex, Aku, Greenfinite, Jadixa],
        team: team,
        version: "1.1"
    },
    methods: {
        refresh: function (event) {
            pull(app.players[tableId[event.target.id]], 0);
        }
      },
    mounted() { 
        //getting localStorage data or deleting them if corrupted

        //first we check version so we can reset data if outdated
        let isVersionUpToDate = false;
        if (localStorage.getItem('version')){ 
            if (localStorage.getItem('version') == this.version){
                isVersionUpToDate = true;
            }
        }

        if (isVersionUpToDate){
            if (localStorage.getItem('players')) {
                try {
                    this.players = JSON.parse(localStorage.getItem('players'));
                    for (let i = 0; i < this.players.length; i++) {
                        this.players[i].fetching = false;
                        if (this.players[i].lastUpdated)
                            this.players[i].lastUpdatedTimer = moment(this.players[i].lastUpdated).fromNow();
                    }
                    console.info("save was imported successfully");
                } catch (e) {
                    console.error("save is corrupted and has been deleted", e);
                    localStorage.removeItem('players');
                }
            }
        }
        else{
            console.warn("App version was outdated - Inconsistent data was removed ")
        } 
    },
});

getTeamStats();


//update the time every 60000 secs
setTimeout(
    function(){
        setInterval(
            function(){
                for (let i = 0; i < app.players.length; i++) {
                    if (app.players[i].lastUpdated)
                        app.players[i].lastUpdatedTimer = moment(app.players[i].lastUpdated).fromNow();
                }
            },
            60000
        )
    },
    60000
)

//save all players data into localstorage 
function save() {
    
    localStorage.setItem('players', JSON.stringify(app.players));
    localStorage.setItem('version', app.version);
    
    console.info("Success - data saved");
    getTeamStats();
}

function getRankIcon(rank){
        //getting rankIcon corresponding to rank
        if (rank >= 4000) return "./assets/ranks/gm.png";
        else if (rank >= 3500) return "./assets/ranks/master.png";
        else if (rank >= 3000) return "./assets/ranks/diamant.png";
        else if (rank >= 2500) return "./assets/ranks/plat.png";
        else return "./assets/ranks/gold.png";
}

function getRankName(rank){
    //getting name corresponding to rank
    if (rank >= 4000) return "gm";
    else if (rank >= 3500) return "master";
    else if (rank >= 3000) return "diamant";
    else if (rank >= 2500) return "plat";
    else return "gold";
}

//calculate team average and best/worst stats
function getTeamStats() {
    let maxRank = 0;
    let maxRankTotal = 0;
    let maxRankIndex = 0;
    let minRank = 5000;
    let minRankPlayer;
    let maxRankPlayer;
    for (let i = 0; i < app.players.length; i++) {

        //calcultating maxRank
        if (app.players[i].maxRank) {
            maxRankIndex++;
            maxRankTotal += app.players[i].maxRank;
            if (app.players[i].maxRank > maxRank) {
                maxRank = app.players[i].maxRank;
                maxRankPlayer = app.players[i].name;
            }
            if (app.players[i].maxRank < minRank) {
                minRank = app.players[i].maxRank;
                minRankPlayer = app.players[i].name;
            }
        }
    }
    let maxRankAverage = Math.round(maxRankTotal / maxRankIndex);

    app.team.maxRank = maxRank;
    app.team.maxRankPlayer = maxRankPlayer;
    app.team.minRank = minRank;
    app.team.minRankPlayer = minRankPlayer;
    app.team.averageMaxRank = maxRankAverage;

    //getting rankIcon corresponding to rank

    team.maxRankIcon = getRankIcon(app.team.maxRank);

    team.minRankIcon = getRankIcon(app.team.minRank);

    team.averageMaxRankIcon = getRankIcon(app.team.averageMaxRank);
}



//fetch player stats (index is smurf n°index n°0 for main)
function pull(player, index) {

    player.fetching = true;
    console.info( player.battletags[index] + " - fetching")

    let url = 'https://owapi.net/api/v3/u/' + player.battletags[index] + '/blob';

    fetch(url)
        .then(function(data) {
            data = data.json();
            return data;
        }).then(function(data) {

            //check if rate limited or private profile or error
            if (data.error == 429) {
                setTimeout(function() {
                    pull(player, index)
                }, 10000);
                console.warn(player.battletags[index] + " - ratelimited - retrying in 10s");
                return false;
            } else if (data.error == 500) {
                console.warn(player.battletags[index] + " - private profil or error - retrying in 60s in case it's an API due error");
                setTimeout(function() {
                    pull(player, index)
                }, 60000);
            } else {
                //if main (first battletag in list)
                if (index == 0) {
                    //if dataset isn't empty (is API trying to trick me sometimes ?)   
                    if (data.eu.stats.competitive.overall_stats) {

                        //gathering data from json
                        player.rank = [data.eu.stats.competitive.overall_stats.comprank];
                        player.maxRank = data.eu.stats.competitive.overall_stats.comprank;
                        player.averageRank = data.eu.stats.competitive.overall_stats.comprank;
                        player.wins = [data.eu.stats.competitive.overall_stats.wins];
                        player.playerIcon = data.eu.stats.competitive.overall_stats.avatar;
                        player.loss = [data.eu.stats.competitive.overall_stats.losses];
                        player.games = [data.eu.stats.competitive.overall_stats.games];
                        player.draws = [data.eu.stats.competitive.overall_stats.ties];
                        player.winrate = data.eu.stats.competitive.overall_stats.win_rate;
                        player.endorsement = data.eu.stats.competitive.overall_stats.endorsement_level;
                        player.rankTotal = data.eu.stats.competitive.overall_stats.comprank;

                        player.winsTotal = player.wins[0];
                        player.gamesTotal = player.games[0];
                        player.drawsTotal = player.draws[0];
                        player.lossTotal = player.loss[0];

                        //calculating winrate color
                        if (player.winrate > 51) player.winrateColor = "green";
                        else if (player.winrate > 49) player.winrateColor = "orange";
                        else player.winrateColor = "red";

                        //getting player level but API stopped sending prestige so won't work for now
                        //player.level = data.eu.stats.competitive.overall_stats.level + 100 * data.eu.stats.competitive.overall_stats.prestige;

                        // calculating rank name / image base on stats

                        player.rankIcon = getRankIcon(player.maxRank);
                        player.rankName = getRankName(player.maxRank);

                        //it's first player so average is his rank
                        player.averageRankIcon = player.rankIcon;


                        // Calcultating mostPlayed heroes
                        // is a bit tricky might be improved
                        // basically setting the objet with playtime as an array in order to loop it 5 times and get the 5 best heroes
                        // could have been done by sorting the array and THEN getting the 5 first

                        player.mostPlayed = data.eu.heroes.playtime.competitive;
                        player.mostPlayedMapped = Object.keys(player.mostPlayed).map(function(key) {
                            return [key, player.mostPlayed[key]];
                        });

                        let most1 = 0;
                        let most11 = "";
                        let most2 = 0;
                        let most22 = "";
                        let most3 = 0;
                        let most33 = "";
                        let most4 = 0;
                        let most44 = "";
                        let most5 = 0;
                        let most55 = "";

                        for (let j = 0; j < 5; j++) {
                            for (let i = 0; i < player.mostPlayedMapped.length; i++) {
                                let key = player.mostPlayedMapped[i][0];
                                let value = player.mostPlayedMapped[i][1];
                                if (value >= most1) {
                                    most1 = value;
                                    most11 = key;
                                } else if (value >= most2) {
                                    most2 = value;
                                    most22 = key;
                                } else if (value >= most3) {
                                    most3 = value;
                                    most33 = key;
                                } else if (value >= most4) {
                                    most4 = value;
                                    most44 = key;
                                } else if (value >= most5) {
                                    most5 = value;
                                    most55 = key;
                                }
                            }
                        }

                        player.mostPlayedTime = [most1, most2, most3, most4, most5];
                        player.mostPlayedKey = [most11, most22, most33, most44, most55];

                        // Detecting how much account have been loaded to show the user
                        if (player.battletags.length == player.rank.length && player.battletags.length == 1) {
                            player.loaded = "Chargement terminé (" + player.battletags.length + " compte)"
                        } else if (player.battletags.length == player.rank.length) {
                            player.loaded = "Chargement terminé (" + player.battletags.length + "comptes)"
                        } else if (player.rank.length == 1) {
                            player.loaded = player.rank.length + " compte chargé sur " + player.battletags.length
                        } else {
                            player.loaded = player.rank.length + " comptes chargés sur " + player.battletags.length
                        }

                        //getting last data update (is then updated via save())
                        player.lastUpdated = moment();
                        player.lastUpdatedTimer = moment().fromNow();

                        //can finally allow the display of the player
                        player.display = true;
                        save();
                    } else {
                        player.fetching = true;
                        console.warn(player.battletags[index] + " - no data - retrying in 60secs (API doesn't like it too fast)");
                        setTimeout(function() {
                            pull(player, index)
                        }, 60000);
                        return false;
                    }
                } else { //if smurf

                    //if dataset isn't empty (is API trying to trick me sometimes ?)   
                    if (data.eu.stats.competitive.overall_stats) {

                        player.averageRankIcon = getRankIcon(player.averageRank)

                        //Adding the smurf rank to the array (if not already done)
                        if (player.rank.length < index + 1) player.rank.push(data.eu.stats.competitive.overall_stats.comprank)

                        if (player.wins.length < index + 1) player.wins.push(data.eu.stats.competitive.overall_stats.wins)
                        if (player.loss.length < index + 1) player.loss.push(data.eu.stats.competitive.overall_stats.losses)
                        if (player.draws.length < index + 1) player.draws.push(data.eu.stats.competitive.overall_stats.ties)
                        if (player.games.length < index + 1) player.games.push(data.eu.stats.competitive.overall_stats.games)

                        //calcultating new average rank
                        let avgRank = 0;
                        let winsTotal = 0;
                        let lossTotal = 0;
                        let drawsTotal = 0;
                        let gamesTotal = 0;
                        for (let i = 0; i < player.rank.length; i++) {
                            avgRank += player.rank[i]
                        }

                        for (let i = 0; i < player.wins.length; i++) {
                            winsTotal += player.wins[i];
                        }

                        for (let i = 0; i < player.loss.length; i++) {
                            lossTotal += player.loss[i];
                        }

                        for (let i = 0; i < player.draws.length; i++) {
                            drawsTotal += player.draws[i];
                        }

                        for (let i = 0; i < player.games.length; i++) {
                            gamesTotal += player.games[i];
                        }

                        player.winrate = (Math.round(((gamesTotal * 100) / lossTotal) * 10) / 10) / 4;
                        player.averageRank = Math.round(avgRank / player.rank.length);

                        player.winsTotal = winsTotal;
                        player.drawsTotal = drawsTotal;
                        player.gamesTotal = gamesTotal;
                        player.lossTotal = lossTotal;



                        //if new best rank, setting the icon


                        player.rankIcon = getRankIcon(player.maxRank);

                        player.averageRankIcon = getRankIcon(player.averageRank);

                        player.rankName = getRankName(player.maxRank);

                        //calculating new hero playtime
                        let mostPlayed = data.eu.heroes.playtime.competitive;
                        let mapped = Object.keys(mostPlayed).map(function(key) {
                            return [key, mostPlayed[key]];
                        });

                        let most1 = 0;
                        let most11 = "";
                        let most2 = 0;
                        let most22 = "";
                        let most3 = 0;
                        let most33 = "";
                        let most4 = 0;
                        let most44 = "";
                        let most5 = 0;
                        let most55 = "";

                        //reunite both array
                        for (let i = 0; i < player.mostPlayedMapped.length; i++) {
                            for (let j = 0; j < mapped.length; j++) {
                                if (player.mostPlayedMapped[i][0] == mapped[j][0]) {
                                    player.mostPlayedMapped[i][1] += mapped[j][1];
                                    mapped[j][0] = null;
                                }
                            }
                        }

                        //then merge them
                        for (let j = 0; j < 5; j++) {
                            for (let i = 0; i < player.mostPlayedMapped.length; i++) {

                                let key = player.mostPlayedMapped[i][0];
                                let value = player.mostPlayedMapped[i][1];
                                if (value >= most1) {
                                    most1 = value;
                                    most11 = key;
                                } else if (value >= most2) {
                                    most2 = value;
                                    most22 = key;
                                } else if (value >= most3) {
                                    most3 = value;
                                    most33 = key;
                                } else if (value >= most4) {
                                    most4 = value;
                                    most44 = key;
                                } else if (value >= most5) {
                                    most5 = value;
                                    most55 = key;
                                }
                            }
                        }

                        player.mostPlayedTime = [most1, most2, most3, most4, most5];
                        player.mostPlayedKey = [most11, most22, most33, most44, most55];

                        //checking if all characters are loaded
                        if (player.battletags.length == player.rank.length && player.battletags.length == 1) {
                            player.loaded = "Chargement terminé (" + player.battletags.length + " compte)"
                        } else if (player.battletags.length == player.rank.length) {
                            player.loaded = "Chargement terminé (" + player.battletags.length + "comptes)"
                        } else if (player.rank.length == 1) {
                            player.loaded = player.rank.length + " compte chargé sur " + player.battletags.length
                        } else {
                            player.loaded = player.rank.length + " comptes chargés sur " + player.battletags.length
                        }

                        save();
                    } else {
                        console.warn(player.battletags[index] + " - no data - retrying in 60secs (API doesn't like it too fast)");
                        player.fetching = true;
                        setTimeout(function() {
                            pull(player, index)
                        }, 60000);
                        return false;
                    }

                }

                if (player.battletags.length > index + 1) {
                    console.info(player.battletags[index + 1] + " - fetching in 10s");

                    //odd but sometimes is goes to false
                    player.fetching = true;
                    setTimeout(function() {
                        pull(player, index + 1)
                    }, 10000);
                    return true;
                } else {
                    player.fetching = false;
                    return true;
                }
            }
        });
}

function showAll() {
    pull(app.players[0], 0);
    setTimeout(function() {
        pull(app.players[1], 0)
    }, 5000);
    setTimeout(function() {
        pull(app.players[2], 0)
    }, 10000);
    setTimeout(function() {
        pull(app.players[3], 0)
    }, 15000);
    setTimeout(function() {
        pull(app.players[4], 0)
    }, 20000);
    setTimeout(function() {
        pull(app.players[5], 0)
    }, 25000);
    setTimeout(function() {
        pull(app.players[6], 0)
    }, 30000);
}